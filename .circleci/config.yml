version: 2.1

jobs:
  backend_ci:
    docker:
      - image: cimg/node:18.0
    steps:
      - checkout
      - run:
          name: Install Backend Dependencies
          command: |
            cd backend
            npm install
      - run:
          name: Run Backend Tests
          command: |
            cd backend
            npm test || echo "No tests"

  frontend_ci:
    docker:
      - image: cimg/node:18.0
    steps:
      - checkout
      - run:
          name: Install Frontend Dependencies
          command: |
            cd frontend
            npm install
            npm run build

  deploy_to_ec2:
    docker:
      - image: cimg/base:stable
    steps:
      - add_ssh_keys:
          fingerprints:
            - "SHA256:HlU12H+DFRoAB+iCeqLJgxMpIXCE9UQv3EgmNugzy3s"
      - run:
          name: Deploy to EC2
          command: |
            ssh -o StrictHostKeyChecking=no ec2-user@$EC2_IP "
              # Install git if not present
              if ! command -v git &> /dev/null; then
                sudo yum install -y git
              fi &&

              # Install Node.js and npm if not present
              if ! command -v node &> /dev/null; then
                curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
                sudo yum install -y nodejs
              fi &&

              # Install pm2 globally if not present
              if ! command -v pm2 &> /dev/null; then
                sudo npm install -g pm2
              fi &&

              # Clone or update the repository
              if [ ! -d /home/ec2-user/blog-app ]; then
                git clone https://github.com/udayasri-kamarsha/new-reepository.git /home/ec2-user/blog-app
              fi &&
              cd /home/ec2-user/blog-app &&
              git pull origin main &&

              cd backend && npm install && cd .. &&
              cd frontend && npm install && npm run build && cd .. &&

              pm2 restart blog-app || pm2 start backend/server.js --name blog-app
            "

workflows:
  ci_cd_pipeline:
    jobs:
      - backend_ci
      - frontend_ci
      - deploy_to_ec2:
          requires:
            - backend_ci
            - frontend_ci
